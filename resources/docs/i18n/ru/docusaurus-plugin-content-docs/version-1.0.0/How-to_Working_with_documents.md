---
title: 'How-to: Работа с документами'
---

## Проведение документов

### Условие

Есть логика работы с заказами.

import {CodeSample} from './CodeSample.mdx'

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=sample1"/>

Для заказов создана форма редактирования.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution1"/>

Кроме того, для заказа добавлен признак **Проведен**. В дальнейшем, заказы только с этим признаком будут участвовать в последующих расчетах (например, при расчете зарезервированного количества).

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=sample3"/>

Необходимо сделать, чтобы на форме заказов вместо кнопки **ОК** была кнопка **Провести**, которая одновременно проставляет признак **Проведен** для заказа, сохраняет изменения и закрывает форму.

### Решение

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution3"/>

При нажатии переименованной кнопки **OK** будет в единой транзакции выполнено действие **post**. При такой схеме, если пользователь захочет "распровести" документ, то он должен зайти в форму редактирования, снять галочку **Проведен** в шапке документа, и нажать последовательно **Сохранить** и **Закрыть**.

## Подбор строк

### Условие

Есть заказ с формой редактирования, аналогичной примеру **Проведение документов**.

Нужно добавить возможность вводить строки заказа путем ввода количества в таблице со списком товаров. При этом любые изменения в строках заказах и этой таблице должны автоматически синхронизироваться друг с другом.

### Решение

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution4"/>

Форма будет выглядеть следующим образом :

![](attachments/46367481/46367490.png)![](attachments/46367481/46367491.png)

При изменении количества на вкладке **Подбор** система будет автоматически изменять строки заказов. При изменении строк заказов также будет меняться количество на вкладке **Подбор**.

В случае, если в заказе будет две или более строк с одной книгой, то система сбросит количество в первых строках и проставит введенное количество в последней строке. Чтобы изменение касалось только последней строки, то нужно при записи количество использовать следующее действие :

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution4a"/>

Однако, такое поведение будет не понятно пользователю, так как после ввода определенного количества на вкладке **Подбор**, в этой же колонке будет показываться суммарное количество по всем строкам, которое отличается от введенного.

Более детальное описание этого механизма можно почитать в этой [статье](https://habr.com/ru/company/lsfusion/blog/464487/).

## Агрегированные документы

### Условие

Есть логика заказов.

Необходимо добавить логику счетов таким образом, чтобы заказ мог автоматически создавать тождественный ему счет.

### Решение

Для реализации такой логики необходимо создать абстрактный [класс](Classes.md) **Invoice** с нужным набором [абстрактных свойств](Property_extension.md).

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution5a"/>

Также создается форма со списком объектов этого абстрактного класса. В ней будут видны объекты всех классов, наследуемых от класса **Invoice**.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution5b"/>

Свойство **edit** будет вызывать форму редактирования текущего объекта, заданную для его класса. Если для класса текущего объекта она не определена, то никаких действий проведено не будет. Свойство **DELETE** удалит текущий объект, если не нарушится никакого ограничения.

В системе не может существовать объект абстрактного класса. Для того, чтобы можно было ввести счет пользователем вручную, создается отдельный класс **UserInvoice**. Для него создаются симметричные абстрактным свойства, которые затем добавляются как их реализация.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution5c"/>

Создаем форму для редактирования пользовательского счета. Добавляем на форму со списком абстрактных счетов кнопку по добавлению пользовательского.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution5d"/>

Для заказа создаем опцию **createInvoice**, по которой будет создаваться счет. Затем создаем конкретный класс **OrderInvoice**, который будет наследоваться от **Invoice**. Объект этого класса будет автоматически создаваться и удаляться системой для каждого заказа, у которого проставлена опция **createInvoice**. Таким образом, этот счет является [агрегированным объектом](Aggregations.md) для соответствующего заказа. Аналогичным образом создается агрегация для строки счета относительно строки заказа.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution5e"/>

Указываем, что при попытке редактирования такого агрегированного счета должна открываться форма редактирования связанного заказа.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseDocument&block=solution5f"/>

При попытке удаления счета, созданного на основе заказа, будет выдано сообщение с ошибкой.

Принципиальное отличие такой схемы через агрегацию от простого создания счета на основе заказа заключается в том, что система сама следит за синхронизацией счета и заказа. При создании на основе, в случае изменения заказа, пользователь должен сам позаботиться о таких же изменениях в счете. Или нужно писать отдельную обработку событий, которая будет этим заниматься.
