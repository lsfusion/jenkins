---
title: 'How-to: Импорт данных'
---

## Пример 1

### Условие

Есть книги, для которых заданы наименование и цена. Также определена логика заказов.

import {CodeSample} from './CodeSample.mdx'

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseImport&block=sample1"/>

Нужно сделать кнопку, которая загрузит содержимое заказа из Excel-файла, выбранного пользователем на своем компьютере.

### Решение

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseImport&block=solution1"/>

Оператор [INPUT](INPUT_operator.md), который запрашивает файл, вызовет пользователю диалог с выбором файлов с расширениями xls и xlsx. При успешном выборе будет вызвано [действие](Actions.md), которое следует после слова **DO**.

Предполагается, что в файле будет три колонки. В первой (A) будет содержаться код книги, во второй (B) - количество, а в третьей (C) - цена. 

Оператор [IMPORT](IMPORT_operator.md) считывает содержимое выбранного файла в локальные свойства, у которых единственным параметром является номер строки. Эти номера начинаются с нуля. В свойстве **imported** будет **TRUE**, если в файле есть строка с соответствующим номером. Затем для каждой такой строки создается соответствующая строка в заказе.

## Пример 2

### Условие

Аналогично **Примеру 1**. Кроме того, задан директорий, в который некоторая внешняя система складывает заказы. Для каждого заказа формируется отдельный файл в формате CSV, в котором хранятся дата и номер заказа (в денормализованном виде), а также код книги, количество и цена.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseImport&block=sample2"/>

Необходимо реализовать действие, которое будет импортировать из этой папки заказы в систему.

### Решение

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseImport&block=solution2"/>

Действие **listFiles** объявлено в системном [модуле](Modules.md) **Utils**. Оно сканирует указанную в параметре папку и считывает все файлы из нее в свойства **fileName** (имя файла) и **fileIsDirectory** (логическое свойство - является ли файл директорием).

Оператор [READ](READ_operator.md) читает указанный файл в локальное свойство с типом **FILE**, которое затем обрабатывает оператор **IMPORT**. В его параметрах указывается, что форматом файла является CSV без заголовка в первой строке, с вертикальной чертой в качестве разделителем и кодировкой CP1251.

Предполагается, что дата и номер в каждой из строк будут содержать одинаковое значение. Поэтому их значения читаются из первой строки с номером 0.

Каждый файл обрабатывается в отдельной новой [сессии изменений](Change_sessions.md) с последующим сохранением путем вызова оператора [APPLY](APPLY_operator.md). Этот оператор записывает в свойство **canceled** **TRUE**, если при сохранении было нарушено некоторое [ограничение](Constraints.md). Дальше при помощи конструкции **MOVE** оператора **READ** файл перемещается либо в папку success, либо в папку error. Это нужно, чтобы действие можно было вызывать повторно, не обрабатывая при этом одни и те же заказы повторно.

Так как полученное действие не имеет параметров, то его можно включать в планировщик для автоматического запуска через определенные промежутки времени.

## Пример 3

### Условие

Аналогично **Примеру 1**.

Во внешней базе данных хранится справочник книг с полями код и наименование.

Нужно сделать действие, которое будет синхронизировать справочник книг со внешней базой данных.

### Решение

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseImport&block=solution3"/>

Синхронизация состоит из трех основных действий. Сначала создаются книги, коды которых есть во внешней базе данных, но нету в нашей базе. Затем для всех книг, которые есть в нашей базе данных изменяются значения на новые. И в конце удаляются книги, коды которых отсутствуют во внешней базе данных.

Таким образом, гарантируется, что после запуска действия справочник книг будет абсолютно идентичен справочнику во внешней системе. Эта схема удобна, когда некоторые мастер-данные ведутся в другой системе. Полученное действие можно добавить в планировщик, которое будет срабатывать через определенные относительное небольшие промежутки во времени, тем самым обеспечивая почти онлайновое обновление справочника.

## Пример 4

### Условие

Аналогично **Примеру 1**.

Для строки заказа добавлена расшифровка этой строки по цветам и размерам.

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseImport&block=sample4"/>

Необходимо реализовать импорт заказов из JSON файла заданной структуры. Пример JSON-файла :

    {
       "version":"v1",
       "order":[
          {
             "date":"03.01.2018",
             "number":"430",
             "detail":[
                {
                   "item":{
                      "id":"132",
                      "info":[
                         {
                            "size":"40",
                            "color":"black",
                            "quantity":2
                         },
                         {
                            "size":"41",
                            "color":"white",
                            "quantity":3
                         }
                      ]
                   },
                   "price":1.99
                },
                {
                   "item":{
                      "id":"136",
                      "info":[
                         {
                            "size":"39",
                            "color":"white",
                            "quantity":4
                         },
                         {
                            "size":"43",
                            "color":"red",
                            "quantity":1
                         }
                      ]
                   },
                   "price":2.99
                }
             ]
          },
          {
             "date":"04.01.2018",
             "number":"435",
             "detail":[
                {
                   "item":{
                      "id":"122",
                      "info":[
                         {
                            "size":"L",
                            "color":"black",
                            "quantity":1
                         },
                         {
                            "size":"XL",
                            "color":"white",
                            "quantity":1
                         }
                      ]
                   },
                   "price":11.99
                },
                {
                   "item":{
                      "id":"126",
                      "info":[
                         {
                            "size":"S",
                            "color":"white",
                            "quantity":1
                         },
                         {
                            "size":"M",
                            "color":"red",
                            "quantity":1
                         }
                      ]
                   },
                   "price":12.99
                }
             ]
          },
       ]
    }

Решение

<CodeSample url="https://ru-documentation.lsfusion.org/sample?file=UseCaseImport&block=solution4"/>

Для реализации импорта нужно объявить форму [структуры](Structured_view.md), соответствующей структуре JSON-файла.

Тэг **version**, который находится на самом высоком уровне, объявляем без входов и добавляем на форму.

Значением тэга **order** является массив, поэтому на форме объявляем объект с именем этого тэга. Платформа создаст по новом объекту для каждого элемента массива в JSON. Свойства **date** и **number** для заказа будут автоматически импортированы из соответствующий тэгов в JSON.

Аналогичным образом, для тэга **detail** создается объект с таким же именем, который через **FILTERS** связывается с объектом **order**. Система при импорте сама заполнит ссылку строки заказа на заказ на основе этого фильтра исходя из вложенности тэгов друг в друга.

Для того, чтобы импортировать значения из тэгов, вложенных в тэг **item**, создается новая [группа](Groups_of_properties_and_actions.md) **item**, в которую затем помещаются свойства и объекты. В частности, создается локальное свойство **idItem** и добавляется на форму в эту группу. Так как имя свойства не совпадает с именем тэга, то для свойства на форме при помощи ключевого слова **EXTID** указывается соответствующее имя.
